<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitor v2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav style="background: #333; color: white; padding: 10px; margin-bottom: 20px;">
        <h1 style="margin: 0; display: inline;">üå¨Ô∏è Air Quality Monitor</h1>
        <div style="float: right;">
             <button onclick="showSection('dashboard')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Dashboard</button>
             <button onclick="showSection('sensors')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Sensor Data</button>
             <button onclick="showSection('device')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Device Info</button>
             <button onclick="showSection('graphs')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Graphs</button>
              <button onclick="showSection('data')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Data Management</button>
              <button onclick="showSection('logs')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Logs</button>
              <button id="settings-btn" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">‚öôÔ∏è Settings</button>
        </div>
    </nav>
    <div class="container">
        <div id="dashboard-section" class="section">
         <div class="data-card">
             <h3>Air Quality Index</h3>
             <div class="metric" style="font-size: 3em; text-align: center;">
                 <span id="aqi" class="value aqi">--</span>
             </div>
             <div style="text-align: center; margin: 10px 0; color: #666;">
                 Location: {{ device_info.location }}
                 <button onclick="openLocationModal()" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Change</button>
             </div>
             <div id="health-advice" class="health-advice" style="text-align: center;"></div>
<div class="share-buttons" style="text-align: center; margin-top: 20px;">
                  <button id="read-now-btn" onclick="readNow()" style="margin: 5px; padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;">üìä Read Now</button>
                  <button onclick="shareScreenshot()" style="margin: 5px; padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">üì∏ Save Screenshot</button>
                  <button onclick="shareScreenshotWithText()" style="margin: 5px; padding: 8px 12px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">üì∏ Share Screenshot</button>
                  <button onclick="shareNative()" style="margin: 5px; padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Share</button>
                  <button onclick="shareWhatsApp()" style="margin: 5px; padding: 8px 12px; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer;">WhatsApp</button>
                  <button onclick="shareTwitter()" style="margin: 5px; padding: 8px 12px; background: #1DA1F2; color: white; border: none; border-radius: 5px; cursor: pointer;">Twitter</button>
                  <button onclick="shareFacebook()" style="margin: 5px; padding: 8px 12px; background: #1877F2; color: white; border: none; border-radius: 5px; cursor: pointer;">Facebook</button>
                  <button onclick="shareCopy()" style="margin: 5px; padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Copy</button>
              </div>
         </div>
        <div id="last-updated" class="last-updated">Last updated: --</div>
        <div class="data-card">
            <h3>AQI Categories & PM2.5 Ranges</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">AQI Range</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">PM2.5 (¬µg/m¬≥)</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Category</th>
                </tr>
                <tr class="good">
                    <td>0-50</td>
                    <td>0-12.0</td>
                    <td>Good</td>
                </tr>
                <tr class="moderate">
                    <td>51-100</td>
                    <td>12.1-35.4</td>
                    <td>Moderate</td>
                </tr>
                <tr class="unhealthy">
                    <td>101-150</td>
                    <td>35.5-55.4</td>
                    <td>Unhealthy for Sensitive Groups</td>
                </tr>
                <tr class="very-unhealthy">
                    <td>151-200</td>
                    <td>55.5-150.4</td>
                    <td>Unhealthy</td>
                </tr>
                <tr class="hazardous">
                    <td>201-300</td>
                    <td>150.5-250.4</td>
                    <td>Very Unhealthy</td>
                </tr>
                <tr class="hazardous">
                    <td>301-500</td>
                    <td>250.5-500.4</td>
                    <td>Hazardous</td>
                </tr>
            </table>
            <p><strong>Ideal Range:</strong> AQI 0-50 (PM2.5 <12 ¬µg/m¬≥) - Air quality is considered satisfactory.</p>
        </div>
        </div>
        <div id="device-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Device Information</h3>
                <p><strong>Hostname:</strong> {{ device_info.hostname }}</p>
                <p><strong>IP Address:</strong> {{ device_info.ip }}</p>
                <p><strong>Platform:</strong> {{ device_info.platform }}</p>
                <p><strong>Sensor:</strong> {{ device_info.sensor_model }}</p>
                <p><strong>Location:</strong> {{ device_info.location }}</p>
            </div>
        </div>
        <div id="sensors-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Particulate Matter Concentrations</h3>
                <div class="metric">
                    PM1.0: <span id="pm1" class="value">--</span> ¬µg/m¬≥
                </div>
                <div class="metric">
                    PM2.5: <span id="pm25" class="value">--</span> ¬µg/m¬≥
                </div>
                <div class="metric">
                    PM10: <span id="pm10" class="value">--</span> ¬µg/m¬≥
                </div>
            </div>
            <div class="data-card">
                <h3>Particle Counts (per 0.1L air)</h3>
                <div class="metric">
                    0.3-0.5 ¬µm: <span id="0_3_um" class="value">--</span>
                </div>
                <div class="metric">
                    0.5-1.0 ¬µm: <span id="0_5_um" class="value">--</span>
                </div>
                <div class="metric">
                    1.0-2.5 ¬µm: <span id="1_0_um" class="value">--</span>
                </div>
                <div class="metric">
                    2.5-5.0 ¬µm: <span id="2_5_um" class="value">--</span>
                </div>
                <div class="metric">
                    5.0-10 ¬µm: <span id="5_0_um" class="value">--</span>
                </div>
                <div class="metric">
                    >10 ¬µm: <span id="10_um" class="value">--</span>
                </div>
            </div>
            <div class="data-card">
                <h3>Sensor Info</h3>
                <div class="metric">
                    Firmware Version: <span id="version" class="value">--</span>
             </div>
         </div>
         <div id="data-section" class="section" style="display: none;">
             <div class="data-card">
                 <h3>Data Management</h3>
                  <div>
                      <label>Location: <select id="data-location"><option value="">All Locations</option></select></label>
                      <button onclick="loadReadings()">Load Data</button>
                      <button onclick="loadMoreReadings()">Load More</button>
                      <input type="number" id="cleanup-days" min="1" max="365" value="30" style="width: 60px;"> days
                      <button onclick="cleanupData()">Clean Old Data</button>
                      <div id="data-loading" class="loading" style="display: none;"></div>
                  </div>
                 <table id="data-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                     <thead>
                         <tr>
                             <th style="border: 1px solid #ddd; padding: 8px;">Timestamp</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">Location</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM1.0</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM2.5</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM10</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">AQI</th>
                         </tr>
                     </thead>
                     <tbody id="data-tbody">
                         <tr><td colspan="6">Loading...</td></tr>
                     </tbody>
                 </table>
              </div>
          </div>
         <div id="logs-section" class="section" style="display: none;">
             <div class="data-card">
                 <h3>Application Logs</h3>
                 <button onclick="loadLogs()">Load Logs</button>
                 <table id="logs-table" style="width: 100%; border-collapse: collapse; margin-top: 20px; overflow-x: auto; display: block; white-space: nowrap;">
                     <thead>
                         <tr>
                             <th style="border: 1px solid #ddd; padding: 8px;">Timestamp</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">Level</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">Message</th>
                         </tr>
                     </thead>
                     <tbody id="logs-tbody">
                         <tr><td colspan="3">Click Load Logs to view</td></tr>
                     </tbody>
                 </table>
             </div>
         </div>
      </div>
        <div id="graphs-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Data Graphs</h3>
                <div>
                    <label>Parameter: 
                        <select id="graph-param">
                            <option value="aqi">AQI</option>
                            <option value="pm1">PM1.0</option>
                            <option value="pm25">PM2.5</option>
                            <option value="pm10">PM10</option>
                        </select>
                    </label>
                <label>Time Range: 
                    <select id="graph-range">
                        <option value="hour">Last 24 Hours</option>
                        <option value="day">Last 7 Days</option>
                        <option value="week">Last 4 Weeks</option>
                        <option value="month">Last 12 Months</option>
                        <option value="year">All Years</option>
                    </select>
                </label>
                <label>Location: <select id="graph-location"><option value="">All Locations</option></select></label>
                <button onclick="loadGraph()" id="load-graph-btn">Load Graph</button>
                 <button onclick="loadComparativeGraph()" id="load-comp-btn">Compare Locations</button>
                 <button onclick="exportData()" id="export-btn">Export Data (CSV)</button>
                 <div id="graph-loading" class="loading" style="display: none;"></div>
                </div>
                <canvas id="graph-canvas" width="400" height="200"></canvas>
                 <h4 id="comp-title">Comparative AQI by Location</h4>
                <canvas id="comp-graph-canvas" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3>Settings</h3>
            <form id="settings-form">
                <div style="margin-bottom: 20px;">
                    <h4>Reading Mode</h4>
                    <label style="display: block; margin: 5px 0;">
                        <input type="radio" name="reading-mode" value="realtime" checked> Real-time Mode
                        <small style="display: block; color: #666; margin-left: 20px;">Continuous readings with minimal rest</small>
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="radio" name="reading-mode" value="less_aggressive"> Less Aggressive Mode
                        <small style="display: block; color: #666; margin-left: 20px;">Balanced approach with moderate rest periods</small>
                    </label>
                    <label style="display: block; margin: 5px 0;">
                        <input type="radio" name="reading-mode" value="lazy"> Lazy Mode
                        <small style="display: block; color: #666; margin-left: 20px;">Manual readings only (Read Now button)</small>
                    </label>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Reading Frequency</h4>
                    <div id="realtime-options" style="display: block;">
                        <label>Interval: 
                            <select id="realtime-interval">
                                <option value="5">5 seconds</option>
                                <option value="10">10 seconds</option>
                                <option value="20">20 seconds</option>
                                <option value="40">40 seconds</option>
                                <option value="60">60 seconds</option>
                            </select>
                        </label>
                    </div>
                    <div id="less-aggressive-options" style="display: none;">
                        <label>Interval: 
                            <select id="less-aggressive-interval">
                                <option value="5">5 minutes</option>
                                <option value="10">10 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                                <option value="120">2 hours</option>
                                <option value="240">4 hours</option>
                                <option value="480">8 hours</option>
                                <option value="1440">24 hours</option>
                            </select>
                        </label>
                    </div>
                    <div id="lazy-options" style="display: none;">
                        <p style="color: #666; font-style: italic;">Lazy mode: Use "Read Now" button on dashboard</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Power Save: <input type="checkbox" id="power-save"></label><br>
                    <small style="color: #666;">Puts sensor to sleep between readings</small>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label>Manual Location: <input type="text" id="manual-location" placeholder="e.g., Home, Office" style="width: 100%;"></label>
                </div>
                
                <button type="submit" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Save Settings</button>
                <button type="button" onclick="closeSettings()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 350px;">
            <h3>Change Location</h3>
            <form id="location-form">
                <label><input type="radio" name="location-type" value="auto" checked> Use Auto-Detected Location</label><br><br>
                <label><input type="radio" name="location-type" value="custom"> Custom Location</label><br>
                <input type="text" id="custom-location-input" placeholder="Enter custom location" style="width: 100%; margin-top: 5px;" disabled><br><br>
                <button type="submit">Save</button>
                <button type="button" onclick="closeLocationModal()">Cancel</button>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        const healthLevels = {
            good: { text: "Air quality is satisfactory, and air pollution poses little or no risk.", color: "#28a745" },
            moderate: { text: "Air quality is acceptable; however, for some pollutants there may be a moderate health concern for a very small number of people.", color: "#ffc107" },
            unhealthy: { text: "Members of sensitive groups may experience health effects. The general public is not likely to be affected.", color: "#fd7e14" },
            "very-unhealthy": { text: "Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.", color: "#dc3545" },
            hazardous: { text: "Health alert: everyone may experience more serious health effects.", color: "#6f42c1" }
        };

function updateData() {
            console.log('DEBUG: updateData called');
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    console.log('DEBUG: API response =', data);
                    if (data.error) {
                        ['pm1', 'pm25', 'pm10', 'aqi', '0_3_um', '0_5_um', '1_0_um', '2_5_um', '5_0_um', '10_um', 'version'].forEach(id => {
                            document.getElementById(id).textContent = 'Error';
                        });
                        document.getElementById('health-advice').textContent = 'Unable to retrieve air quality data.';
                        document.getElementById('health-advice').style.backgroundColor = '#f8d7da';
                    } else if (data.mode && data.message) {
                        // Handle mode-specific messages
                        document.getElementById('health-advice').textContent = data.message;
                        document.getElementById('health-advice').style.backgroundColor = '#fff3cd';
                        document.getElementById('health-advice').style.border = '1px solid #ffc107';

                        // Show mode indicator
                        let modeText = 'Real-time Mode';
                        if (data.mode === 'lazy') {
                            modeText = 'Lazy Mode';
                        } else if (data.mode === 'less_aggressive') {
                            modeText = 'Less Aggressive Mode';
                        }
                        document.getElementById('last-updated').textContent = `${modeText} - ${data.message}`;
                    } else {
                        // Normal data processing
                        document.getElementById('pm1').textContent = data.pm1 !== null ? data.pm1 : 'N/A';
                        document.getElementById('pm25').textContent = data.pm25;
                        document.getElementById('pm10').textContent = data.pm10 !== null ? data.pm10 : 'N/A';
                        document.getElementById('aqi').textContent = data.aqi;

                        const aqiElement = document.getElementById('aqi');
                        aqiElement.className = 'value aqi';
                        let level;
                        if (data.aqi <= 50) {
                            level = 'good';
                        } else if (data.aqi <= 100) {
                            level = 'moderate';
                        } else if (data.aqi <= 150) {
                            level = 'unhealthy';
                        } else if (data.aqi <= 200) {
                            level = 'very-unhealthy';
                        } else {
                            level = 'hazardous';
                        }
                        aqiElement.classList.add(level);
                        const advice = document.getElementById('health-advice');
                        advice.textContent = healthLevels[level].text;
                        advice.style.backgroundColor = healthLevels[level].color + '20';
                        advice.style.border = `1px solid ${healthLevels[level].color}`;

                        // Highlight current category in table
                        const rows = document.querySelectorAll('tr');
                        rows.forEach(row => row.classList.remove('current'));
                        const currentRow = document.querySelector(`tr.${level}`);
                        if (currentRow) currentRow.classList.add('current');

                        // Update particle counts and version only if in sensors section
                        if (document.getElementById('sensors-section').style.display !== 'none' && data.particles) {
                            Object.keys(data.particles).forEach(key => {
                                const element = document.getElementById(key.replace('_', '_'));
                                if (element) element.textContent = data.particles[key] !== null ? data.particles[key] : 'N/A';
                            });
                            const versionEl = document.getElementById('version');
                            if (versionEl) versionEl.textContent = data.version !== null ? data.version : 'N/A';
                        }

                        // Show mode and next reading time
                        if (data.mode) {
                            const modeText = data.mode === 'lazy' ? 'Lazy Mode' :
                                            data.mode === 'less_aggressive' ? 'Less Aggressive Mode' : 'Real-time Mode';
                            document.getElementById('last-updated').textContent = `${modeText} - Last updated: ${new Date().toLocaleTimeString()}`;
                        } else {
                            document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('pm25').textContent = 'Error';
                    document.getElementById('aqi').textContent = 'Error';
                    document.getElementById('health-advice').textContent = 'Connection error. Please check your network.';
                    document.getElementById('health-advice').style.backgroundColor = '#f8d7da';
                });
        }

        function updateModeUI(mode) {
            // Show/hide Read Now button for lazy mode
            const readNowBtn = document.getElementById('read-now-btn');
            if (readNowBtn) {
                readNowBtn.style.display = mode === 'lazy' ? 'inline-block' : 'none';
            }
            
            // Show/hide interval options based on mode
            document.getElementById('realtime-options').style.display = mode === 'realtime' ? 'block' : 'none';
            document.getElementById('less-aggressive-options').style.display = mode === 'less_aggressive' ? 'block' : 'none';
            document.getElementById('lazy-options').style.display = mode === 'lazy' ? 'block' : 'none';
        }

        function readNow() {
            const btn = document.getElementById('read-now-btn');
            const originalText = btn.textContent;
            btn.textContent = 'üîÑ Reading...';
            btn.disabled = true;
            
            fetch('/api/read_now')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('health-advice').textContent = data.error;
                        document.getElementById('health-advice').style.backgroundColor = '#f8d7da';
                    } else {
                        // Update display with manual reading
                        document.getElementById('pm1').textContent = data.pm1 !== null ? data.pm1 : 'N/A';
                        document.getElementById('pm25').textContent = data.pm25;
                        document.getElementById('pm10').textContent = data.pm10 !== null ? data.pm10 : 'N/A';
                        document.getElementById('aqi').textContent = data.aqi;
                        
                        const aqiElement = document.getElementById('aqi');
                        aqiElement.className = 'value aqi';
                        let level;
                        if (data.aqi <= 50) {
                            level = 'good';
                        } else if (data.aqi <= 100) {
                            level = 'moderate';
                        } else if (data.aqi <= 150) {
                            level = 'unhealthy';
                        } else if (data.aqi <= 200) {
                            level = 'very-unhealthy';
                        } else {
                            level = 'hazardous';
                        }
                        aqiElement.classList.add(level);
                        
                        const advice = document.getElementById('health-advice');
                        advice.textContent = healthLevels[level].text;
                        advice.style.backgroundColor = healthLevels[level].color + '20';
                        advice.style.border = `1px solid ${healthLevels[level].color}`;
                        
                        document.getElementById('last-updated').textContent = `Manual reading - ${new Date().toLocaleTimeString()}`;
                        
                        showNotification('Reading completed successfully!', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error reading now:', error);
                    showNotification('Failed to read sensor', 'error');
                })
                .finally(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }
        let updateInterval = {{ settings.update_interval|default(5000) }};
        let intervalId;
        let currentMode = '{{ settings.reading_mode|default("realtime") }}';
        console.log('DEBUG: Page loaded, currentMode =', currentMode);
        
        // Don't initialize interval here - wait for settings to load
        updateData(); // Initial load

        // Load settings
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                currentMode = data.reading_mode || 'realtime';
                updateInterval = data.custom_interval || 5000;
                
                // Update UI based on mode
                updateModeUI(currentMode);
                
                // Set form values
                document.getElementById('power-save').checked = data.power_save || false;
                document.getElementById('manual-location').value = data.manual_location || '';
                
                // Set reading mode radio
                const modeRadio = document.querySelector(`input[name="reading-mode"][value="${currentMode}"]`);
                if (modeRadio) modeRadio.checked = true;
                
                // Set interval based on mode
                if (currentMode === 'realtime') {
                    const seconds = Math.floor(updateInterval / 1000);
                    const realtimeSelect = document.getElementById('realtime-interval');
                    if (realtimeSelect) realtimeSelect.value = seconds.toString();
                } else if (currentMode === 'less_aggressive') {
                    const minutes = Math.floor(updateInterval / 60000);
                    const lessAggressiveSelect = document.getElementById('less-aggressive-interval');
                    if (lessAggressiveSelect) lessAggressiveSelect.value = minutes.toString();
                }
                
                // Initialize interval after settings are loaded
                if (currentMode !== 'lazy') {
                    if (intervalId) clearInterval(intervalId);
                    intervalId = setInterval(updateData, updateInterval);
                }
            })
            .catch(error => {
                console.error('Error loading settings:', error);
                // Use defaults if settings fail to load
                currentMode = 'realtime';
                updateInterval = 5000;
                updateModeUI(currentMode);
                // Initialize interval with defaults
                if (intervalId) clearInterval(intervalId);
                intervalId = setInterval(updateData, updateInterval);
            });

        // Load locations
        fetch('/api/locations')
            .then(response => response.json())
            .then(locations => {
                const selects = ['graph-location', 'data-location'];
                selects.forEach(selId => {
                    const select = document.getElementById(selId);
                    if (select) {
                        locations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc;
                            option.textContent = loc;
                            select.appendChild(option);
                        });
                    }
                });
                // Set default to manual location if available
                fetch('/api/settings')
                    .then(response => response.json())
                    .then(settings => {
                        if (settings.manual_location) {
                            const graphLocation = document.getElementById('graph-location');
                            const dataLocation = document.getElementById('data-location');
                            if (graphLocation) graphLocation.value = settings.manual_location;
                            if (dataLocation) dataLocation.value = settings.manual_location;
                        }
                    })
                    .catch(error => console.error('Error loading settings for locations:', error));
            })
            .catch(error => console.error('Error loading locations:', error));

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(section + '-section').style.display = 'block';
            if (section === 'data') {
                loadReadings();
            } else if (section === 'logs') {
                loadLogs();
            }
        }

        // Settings modal
        document.getElementById('settings-btn').onclick = () => {
            document.getElementById('settings-modal').style.display = 'block';
        };

        // Location modal
        function openLocationModal() {
            document.getElementById('location-modal').style.display = 'block';
            // Load current settings
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.manual_location) {
                        document.querySelector('input[name="location-type"][value="custom"]').checked = true;
                        document.getElementById('custom-location-input').value = data.manual_location;
                        document.getElementById('custom-location-input').disabled = false;
                    } else {
                        document.querySelector('input[name="location-type"][value="auto"]').checked = true;
                        document.getElementById('custom-location-input').disabled = true;
                    }
                });
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        // Handle radio buttons
        document.querySelectorAll('input[name="location-type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const customInput = document.getElementById('custom-location-input');
                customInput.disabled = radio.value !== 'custom';
                if (radio.value === 'custom') {
                    customInput.focus();
                }
            });
        });

        document.getElementById('location-form').onsubmit = (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="location-type"]:checked').value;
            let newLocation = '';
            if (type === 'custom') {
                newLocation = document.getElementById('custom-location-input').value.trim();
                if (!newLocation) {
                    alert('Please enter a custom location.');
                    return;
                }
            }
            // Update settings
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_location: newLocation })
            }).then(() => {
                closeLocationModal();
                location.reload(); // Reload to update location display
            });
        };

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Handle reading mode changes
        document.querySelectorAll('input[name="reading-mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                updateModeUI(radio.value);
            });
        });

        document.getElementById('settings-form').onsubmit = (e) => {
            e.preventDefault();
            const mode = document.querySelector('input[name="reading-mode"]:checked').value;
            let interval;
            
            if (mode === 'realtime') {
                interval = document.getElementById('realtime-interval').value;
            } else if (mode === 'less_aggressive') {
                interval = document.getElementById('less-aggressive-interval').value;
            } else {
                interval = '0'; // Lazy mode
            }
            
            const newSettings = {
                reading_mode: mode,
                interval: interval,
                power_save: document.getElementById('power-save').checked,
                manual_location: document.getElementById('manual-location').value.trim()
            };
            
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newSettings)
            }).then(response => response.json())
            .then(data => {
                closeSettings();
                currentMode = mode;
                updateInterval = data.settings ? data.settings.custom_interval || 5000 : 5000;
                
                // Update auto-refresh interval
                if (intervalId) {
                    clearInterval(intervalId);
                }
                if (mode !== 'lazy') {
                    intervalId = setInterval(updateData, updateInterval);
                }
                
                // Update UI
                updateModeUI(mode);
                
                // Reload page to apply changes
                location.reload();
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('Failed to save settings. Please try again.');
            });
        };

        let chart;
        function loadGraph() {
            const btn = document.getElementById('load-graph-btn');
            const loading = document.getElementById('graph-loading');
            btn.disabled = true;
            loading.style.display = 'inline-block';
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            const location = document.getElementById('graph-location').value;
            const url = `/api/graph_data?param=${param}&range=${range}${location ? '&location=' + encodeURIComponent(location) : ''}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(d => d.time);
                    const values = data.map(d => d.value);
                    const ctx = document.getElementById('graph-canvas').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${param.toUpperCase()} (${location || 'Current Location'})`,
                                data: values,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                })
                .finally(() => {
                    btn.disabled = false;
                    loading.style.display = 'none';
                });
        }

        let compChart;
        let dataOffset = 0;
        function loadComparativeGraph() {
            const btn = document.getElementById('load-comp-btn');
            const loading = document.getElementById('graph-loading');
            btn.disabled = true;
            loading.style.display = 'inline-block';
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            document.getElementById('comp-title').textContent = `Comparative ${param.toUpperCase()} by Location`;
            fetch(`/api/graph_data?param=${param}&range=${range}`)
                .then(response => response.json())
                .then(allData => {
                    // Group by location
                    const locationData = {};
                    allData.forEach(d => {
                        if (!locationData[d.location]) locationData[d.location] = [];
                        locationData[d.location].push(d);
                    });
                    const datasets = Object.keys(locationData).map((loc, i) => ({
                        label: loc,
                        data: locationData[loc].map(d => d.value),
                        borderColor: `hsl(${i * 360 / Object.keys(locationData).length}, 70%, 50%)`,
                        backgroundColor: 'transparent',
                        tension: 0.1
                    }));
                    const labels = allData.slice(0, datasets[0]?.data.length || 0).map(d => d.time);
                    const ctx = document.getElementById('comp-graph-canvas').getContext('2d');
                    if (compChart) compChart.destroy();
                    compChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                })
                .finally(() => {
                    btn.disabled = false;
                    loading.style.display = 'none';
                });
        }

        function exportData() {
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            const location = document.getElementById('graph-location').value;
            const url = `/api/export?format=csv${location ? '&location=' + encodeURIComponent(location) : ''}`;
            window.open(url, '_blank');
        }

        function loadReadings(append) {
            if (append === undefined) append = false;
            const location = document.getElementById('data-location').value;
            const loading = document.getElementById('data-loading');
            loading.style.display = 'inline-block';
            if (!append) {
                dataOffset = 0;
            }
            const url = `/api/readings?limit=100&offset=${dataOffset}${location ? '&location=' + encodeURIComponent(location) : ''}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('loadReadings: received data, length:', data.length);
                    const tbody = document.getElementById('data-tbody');
                    if (!append) {
                        tbody.innerHTML = '';
                    }
                    if (data.length === 0 && !append) {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 6;
                        td.textContent = 'No data available';
                        td.style.textAlign = 'center';
                        td.style.border = '1px solid #ddd';
                        td.style.padding = '8px';
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                    } else {
                        data.forEach(row => {
                            const tr = document.createElement('tr');
                            const td1 = document.createElement('td');
                            td1.textContent = new Date(row.timestamp).toLocaleString();
                            td1.style.border = '1px solid #ddd';
                            td1.style.padding = '8px';
                            const td2 = document.createElement('td');
                            td2.textContent = row.location;
                            td2.style.border = '1px solid #ddd';
                            td2.style.padding = '8px';
                            const td3 = document.createElement('td');
                            td3.textContent = row.pm1 || 'N/A';
                            td3.style.border = '1px solid #ddd';
                            td3.style.padding = '8px';
                            const td4 = document.createElement('td');
                            td4.textContent = row.pm25 || 'N/A';
                            td4.style.border = '1px solid #ddd';
                            td4.style.padding = '8px';
                            const td5 = document.createElement('td');
                            td5.textContent = row.pm10 || 'N/A';
                            td5.style.border = '1px solid #ddd';
                            td5.style.padding = '8px';
                            const td6 = document.createElement('td');
                            td6.textContent = row.aqi || 'N/A';
                            td6.style.border = '1px solid #ddd';
                            td6.style.padding = '8px';
                            tr.appendChild(td1);
                            tr.appendChild(td2);
                            tr.appendChild(td3);
                            tr.appendChild(td4);
                            tr.appendChild(td5);
                            tr.appendChild(td6);
                            tbody.appendChild(tr);
                        });
                        if (data.length > 0) {
                            dataOffset += 100;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading readings:', error);
                    const tbody = document.getElementById('data-tbody');
                    if (!append) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; border: 1px solid #ddd; padding: 8px;">Error loading data</td></tr>';
                    }
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
        }

        function loadMoreReadings() {
            loadReadings(true);
        }

        function cleanupData() {
            const days = parseInt(document.getElementById('cleanup-days').value) || 30;
            if (confirm(`Are you sure you want to delete data older than ${days} days?`)) {
                fetch('/api/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: days})
                }).then(() => {
                    alert('Old data cleaned.');
                    loadReadings(); // Refresh the table
                });
            }
        }

        function loadLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('logs-tbody');
                    tbody.innerHTML = '';
                    if (data.error) {
                        tbody.innerHTML = '<tr><td colspan="3">Error: ' + data.error + '</td></tr>';
                        return;
                    }
                    data.forEach(log => {
                        const tr = document.createElement('tr');
                        const td1 = document.createElement('td');
                        td1.textContent = log.timestamp;
                        td1.style.border = '1px solid #ddd';
                        td1.style.padding = '8px';
                        const td2 = document.createElement('td');
                        td2.textContent = log.level;
                        td2.style.border = '1px solid #ddd';
                        td2.style.padding = '8px';
                        const td3 = document.createElement('td');
                        td3.textContent = log.message;
                        td3.style.border = '1px solid #ddd';
                        td3.style.padding = '8px';
                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tr.appendChild(td3);
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    document.getElementById('logs-tbody').innerHTML = '<tr><td colspan="3">Error loading logs</td></tr>';
                });
        }

        // Load data and logs on page load (only if not already loaded by showSection)
        // These are called when sections are shown, so we don't need to call them here

        function shareWhatsApp() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const text = `Current Air Quality: AQI ${aqi}, PM2.5 ${pm25} ¬µg/m¬≥. Check live at ${window.location.href}`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareTwitter() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const text = `Current Air Quality: AQI ${aqi}, PM2.5 ${pm25} ¬µg/m¬≥. Check live at ${window.location.href}`;
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareFacebook() {
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`;
            window.open(url, '_blank');
        }

        function shareCopy() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const text = `Current Air Quality: AQI ${aqi}, PM2.5 ${pm25} ¬µg/m¬≥. Check live at ${window.location.href}`;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
            } else {
                alert('Copy not supported in this browser.');
            }
        }

        function shareScreenshot() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const timestamp = new Date().toLocaleString();
            
            // Show loading indicator
            const btn = event ? event.target : this;
            const originalText = btn.textContent;
            btn.textContent = 'üì∏ Capturing...';
            btn.disabled = true;
            
            // Capture the dashboard section
            const dashboardElement = document.getElementById('dashboard-section');
            
            html2canvas(dashboardElement, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                // Convert canvas to blob
                canvas.toBlob(blob => {
                    // Create object URL for the image
                    const imageUrl = URL.createObjectURL(blob);
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `air-quality-${timestamp.replace(/[/:]/g, '-')}.png`;
                    link.href = imageUrl;
                    link.click();
                    
                    // Clean up
                    setTimeout(() => URL.revokeObjectURL(imageUrl), 100);
                    
                    // Reset button
                    btn.textContent = originalText;
                    btn.disabled = false;
                    
                    // Show success message
                    showNotification('Screenshot saved successfully!', 'success');
                }, 'image/png');
            }).catch(error => {
                console.error('Screenshot failed:', error);
                btn.textContent = originalText;
                btn.disabled = false;
                showNotification('Failed to capture screenshot', 'error');
            });
        }

        function shareScreenshotWithText() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const timestamp = new Date().toLocaleString();
            
            // Show loading indicator
            const btn = event ? event.target : this;
            const originalText = btn.textContent;
            btn.textContent = 'üì∏ Capturing...';
            btn.disabled = true;
            
            // Capture the dashboard section
            const dashboardElement = document.getElementById('dashboard-section');
            
            html2canvas(dashboardElement, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                // Convert canvas to blob
                canvas.toBlob(blob => {
                    // Create file input for sharing
                    const file = new File([blob], `air-quality-${timestamp.replace(/[/:]/g, '-')}.png`, { type: 'image/png' });
                    
                    const text = `Air Quality Monitor\nAQI: ${aqi}\nPM2.5: ${pm25} ¬µg/m¬≥\nTime: ${timestamp}\n\nLive data: ${window.location.href}`;
                    
                    // Try to share with file
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            title: 'Air Quality Monitor',
                            text: text,
                            files: [file],
                            url: window.location.href
                        }).then(() => {
                            showNotification('Shared successfully!', 'success');
                        }).catch(err => {
                            console.error('Share failed:', err);
                            shareScreenshotFallback(canvas, text);
                        }).finally(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        });
                    } else {
                        shareScreenshotFallback(canvas, text);
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                }, 'image/png');
            }).catch(error => {
                console.error('Screenshot failed:', error);
                btn.textContent = originalText;
                btn.disabled = false;
                showNotification('Failed to capture screenshot', 'error');
            });
        }

        function shareScreenshotFallback(canvas, text) {
            // Convert to data URL and try to share
            const dataUrl = canvas.toDataURL('image/png');
            
            if (navigator.share) {
                navigator.share({
                    title: 'Air Quality Monitor',
                    text: text,
                    url: window.location.href
                }).catch(err => {
                    console.error('Share failed:', err);
                    // Fallback: copy to clipboard
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Copied to clipboard!', 'success');
                }).catch(err => {
                    showNotification('Failed to copy to clipboard', 'error');
                });
            } else {
                showNotification('Clipboard not supported in this browser', 'error');
            }
        }

        function shareNative() {
            const aqi = document.getElementById('aqi').textContent;
            const pm25 = document.getElementById('pm25').textContent;
            const text = `Current Air Quality: AQI ${aqi}, PM2.5 ${pm25} ¬µg/m¬≥. Check live at ${window.location.href}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Air Quality Monitor',
                    text: text,
                    url: window.location.href
                }).catch(err => console.error('Error sharing:', err));
            } else {
                alert('Native share not supported. Use the other buttons.');
            }
        }
    </script>
</body>
</html>