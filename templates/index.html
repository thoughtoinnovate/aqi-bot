<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav style="background: #333; color: white; padding: 10px; margin-bottom: 20px;">
        <h1 style="margin: 0; display: inline;">üå¨Ô∏è Air Quality Monitor</h1>
        <div style="float: right;">
             <button onclick="showSection('dashboard')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Dashboard</button>
             <button onclick="showSection('sensors')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Sensor Data</button>
             <button onclick="showSection('device')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Device Info</button>
             <button onclick="showSection('graphs')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Graphs</button>
             <button onclick="showSection('data')" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">Data Management</button>
             <button id="settings-btn" style="background: none; border: none; color: white; cursor: pointer; margin: 0 10px;">‚öôÔ∏è Settings</button>
        </div>
    </nav>
    <div class="container">
        <div id="dashboard-section" class="section">
        <div class="data-card">
            <h3>Air Quality Index</h3>
            <div class="metric" style="font-size: 3em; text-align: center;">
                <span id="aqi" class="value aqi">--</span>
            </div>
            <div style="text-align: center; margin: 10px 0; color: #666;">
                Location: {{ device_info.location }}
                <button onclick="openLocationModal()" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Change</button>
            </div>
            <div id="health-advice" class="health-advice" style="text-align: center;"></div>
        </div>
        <div id="last-updated" class="last-updated">Last updated: --</div>
        <div class="data-card">
            <h3>AQI Categories & PM2.5 Ranges</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">AQI Range</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">PM2.5 (¬µg/m¬≥)</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Category</th>
                </tr>
                <tr class="good">
                    <td>0-50</td>
                    <td>0-12.0</td>
                    <td>Good</td>
                </tr>
                <tr class="moderate">
                    <td>51-100</td>
                    <td>12.1-35.4</td>
                    <td>Moderate</td>
                </tr>
                <tr class="unhealthy">
                    <td>101-150</td>
                    <td>35.5-55.4</td>
                    <td>Unhealthy for Sensitive Groups</td>
                </tr>
                <tr class="very-unhealthy">
                    <td>151-200</td>
                    <td>55.5-150.4</td>
                    <td>Unhealthy</td>
                </tr>
                <tr class="hazardous">
                    <td>201-300</td>
                    <td>150.5-250.4</td>
                    <td>Very Unhealthy</td>
                </tr>
                <tr class="hazardous">
                    <td>301-500</td>
                    <td>250.5-500.4</td>
                    <td>Hazardous</td>
                </tr>
            </table>
            <p><strong>Ideal Range:</strong> AQI 0-50 (PM2.5 <12 ¬µg/m¬≥) - Air quality is considered satisfactory.</p>
        </div>
        </div>
        <div id="device-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Device Information</h3>
                <p><strong>Hostname:</strong> {{ device_info.hostname }}</p>
                <p><strong>IP Address:</strong> {{ device_info.ip }}</p>
                <p><strong>Platform:</strong> {{ device_info.platform }}</p>
                <p><strong>Sensor:</strong> {{ device_info.sensor_model }}</p>
                <p><strong>Location:</strong> {{ device_info.location }}</p>
            </div>
        </div>
        <div id="sensors-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Particulate Matter Concentrations</h3>
                <div class="metric">
                    PM1.0: <span id="pm1" class="value">--</span> ¬µg/m¬≥
                </div>
                <div class="metric">
                    PM2.5: <span id="pm25" class="value">--</span> ¬µg/m¬≥
                </div>
                <div class="metric">
                    PM10: <span id="pm10" class="value">--</span> ¬µg/m¬≥
                </div>
            </div>
            <div class="data-card">
                <h3>Particle Counts (per 0.1L air)</h3>
                <div class="metric">
                    0.3-0.5 ¬µm: <span id="0_3_um" class="value">--</span>
                </div>
                <div class="metric">
                    0.5-1.0 ¬µm: <span id="0_5_um" class="value">--</span>
                </div>
                <div class="metric">
                    1.0-2.5 ¬µm: <span id="1_0_um" class="value">--</span>
                </div>
                <div class="metric">
                    2.5-5.0 ¬µm: <span id="2_5_um" class="value">--</span>
                </div>
                <div class="metric">
                    5.0-10 ¬µm: <span id="5_0_um" class="value">--</span>
                </div>
                <div class="metric">
                    >10 ¬µm: <span id="10_um" class="value">--</span>
                </div>
            </div>
            <div class="data-card">
                <h3>Sensor Info</h3>
                <div class="metric">
                    Firmware Version: <span id="version" class="value">--</span>
             </div>
         </div>
         <div id="data-section" class="section" style="display: none;">
             <div class="data-card">
                 <h3>Data Management</h3>
                 <div>
                     <label>Location: <select id="data-location"><option value="">All Locations</option></select></label>
                     <button onclick="loadReadings()">Load Data</button>
                     <button onclick="cleanupData()">Clean Old Data (>30 days)</button>
                     <div id="data-loading" class="loading" style="display: none;"></div>
                 </div>
                 <table id="data-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                     <thead>
                         <tr>
                             <th style="border: 1px solid #ddd; padding: 8px;">Timestamp</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">Location</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM1.0</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM2.5</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">PM10</th>
                             <th style="border: 1px solid #ddd; padding: 8px;">AQI</th>
                         </tr>
                     </thead>
                     <tbody id="data-tbody">
                     </tbody>
                 </table>
             </div>
         </div>
     </div>
        <div id="graphs-section" class="section" style="display: none;">
            <div class="data-card">
                <h3>Data Graphs</h3>
                <div>
                    <label>Parameter: 
                        <select id="graph-param">
                            <option value="aqi">AQI</option>
                            <option value="pm1">PM1.0</option>
                            <option value="pm25">PM2.5</option>
                            <option value="pm10">PM10</option>
                        </select>
                    </label>
                <label>Time Range: 
                    <select id="graph-range">
                        <option value="hour">Last 24 Hours</option>
                        <option value="day">Last 7 Days</option>
                        <option value="week">Last 4 Weeks</option>
                        <option value="month">Last 12 Months</option>
                        <option value="year">All Years</option>
                    </select>
                </label>
                <label>Location: <select id="graph-location"><option value="">All Locations</option></select></label>
                <button onclick="loadGraph()" id="load-graph-btn">Load Graph</button>
                 <button onclick="loadComparativeGraph()" id="load-comp-btn">Compare Locations</button>
                 <button onclick="exportData()" id="export-btn">Export Data (CSV)</button>
                 <div id="graph-loading" class="loading" style="display: none;"></div>
                </div>
                <canvas id="graph-canvas" width="400" height="200"></canvas>
                 <h4 id="comp-title">Comparative AQI by Location</h4>
                <canvas id="comp-graph-canvas" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 300px;">
            <h3>Settings</h3>
            <form id="settings-form">
                <label>Update Interval (seconds): <input type="number" id="update-interval" min="1" max="60"></label><br><br>
                <label>Power Save: <input type="checkbox" id="power-save"></label><br><br>
                <label>Manual Location: <input type="text" id="manual-location" placeholder="e.g., Home, Office"></label><br><br>
                <button type="submit">Save</button>
                <button type="button" onclick="closeSettings()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 350px;">
            <h3>Change Location</h3>
            <form id="location-form">
                <label><input type="radio" name="location-type" value="auto" checked> Use Auto-Detected Location</label><br><br>
                <label><input type="radio" name="location-type" value="custom"> Custom Location</label><br>
                <input type="text" id="custom-location-input" placeholder="Enter custom location" style="width: 100%; margin-top: 5px;" disabled><br><br>
                <button type="submit">Save</button>
                <button type="button" onclick="closeLocationModal()">Cancel</button>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const healthLevels = {
            good: { text: "Air quality is satisfactory, and air pollution poses little or no risk.", color: "#28a745" },
            moderate: { text: "Air quality is acceptable; however, for some pollutants there may be a moderate health concern for a very small number of people.", color: "#ffc107" },
            unhealthy: { text: "Members of sensitive groups may experience health effects. The general public is not likely to be affected.", color: "#fd7e14" },
            "very-unhealthy": { text: "Everyone may begin to experience health effects; members of sensitive groups may experience more serious health effects.", color: "#dc3545" },
            hazardous: { text: "Health alert: everyone may experience more serious health effects.", color: "#6f42c1" }
        };

        function updateData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        ['pm1', 'pm25', 'pm10', 'aqi', '0_3_um', '0_5_um', '1_0_um', '2_5_um', '5_0_um', '10_um', 'version'].forEach(id => {
                            document.getElementById(id).textContent = 'Error';
                        });
                        document.getElementById('health-advice').textContent = 'Unable to retrieve air quality data.';
                        document.getElementById('health-advice').style.backgroundColor = '#f8d7da';
                    } else {
                        document.getElementById('pm1').textContent = data.pm1 !== null ? data.pm1 : 'N/A';
                        document.getElementById('pm25').textContent = data.pm25;
                        document.getElementById('pm10').textContent = data.pm10 !== null ? data.pm10 : 'N/A';
                        document.getElementById('aqi').textContent = data.aqi;
                        const aqiElement = document.getElementById('aqi');
                        aqiElement.className = 'value aqi';
                        let level;
                        if (data.aqi <= 50) {
                            level = 'good';
                        } else if (data.aqi <= 100) {
                            level = 'moderate';
                        } else if (data.aqi <= 150) {
                            level = 'unhealthy';
                        } else if (data.aqi <= 200) {
                            level = 'very-unhealthy';
                        } else {
                            level = 'hazardous';
                        }
                        aqiElement.classList.add(level);
                        const advice = document.getElementById('health-advice');
                        advice.textContent = healthLevels[level].text;
                        advice.style.backgroundColor = healthLevels[level].color + '20';
                        advice.style.border = `1px solid ${healthLevels[level].color}`;

                        // Highlight current category in table
                        const rows = document.querySelectorAll('tr');
                        rows.forEach(row => row.classList.remove('current'));
                        const currentRow = document.querySelector(`tr.${level}`);
                        if (currentRow) currentRow.classList.add('current');

                        // Update particle counts and version only if in sensors section
                        if (document.getElementById('sensors-section').style.display !== 'none') {
                            Object.keys(data.particles).forEach(key => {
                                const element = document.getElementById(key.replace('_', '_'));
                                if (element) element.textContent = data.particles[key] !== null ? data.particles[key] : 'N/A';
                            });
                            const versionEl = document.getElementById('version');
                            if (versionEl) versionEl.textContent = data.version !== null ? data.version : 'N/A';
                        }
                    }
                    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    document.getElementById('pm25').textContent = 'Error';
                    document.getElementById('aqi').textContent = 'Error';
                    document.getElementById('health-advice').textContent = 'Connection error. Please check your network.';
                    document.getElementById('health-advice').style.backgroundColor = '#f8d7da';
                });
        }
        let updateInterval = {{ settings.update_interval }};
        let intervalId = setInterval(updateData, updateInterval);
        updateData(); // Initial load

        // Load settings
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                document.getElementById('update-interval').value = data.update_interval / 1000;
                document.getElementById('power-save').checked = data.power_save;
                document.getElementById('manual-location').value = data.manual_location || '';
            });

        // Load locations
        fetch('/api/locations')
            .then(response => response.json())
            .then(locations => {
                const selects = ['graph-location', 'data-location'];
                selects.forEach(selId => {
                    const select = document.getElementById(selId);
                    locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc;
                        option.textContent = loc;
                        select.appendChild(option);
                    });
                });
                // Set default to manual location if available
                fetch('/api/settings')
                    .then(response => response.json())
                    .then(settings => {
                        if (settings.manual_location) {
                            document.getElementById('graph-location').value = settings.manual_location;
                            document.getElementById('data-location').value = settings.manual_location;
                        }
                    });
            });

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(section + '-section').style.display = 'block';
            if (section === 'data') {
                loadReadings();
            }
        }

        // Settings modal
        document.getElementById('settings-btn').onclick = () => {
            document.getElementById('settings-modal').style.display = 'block';
        };

        // Location modal
        function openLocationModal() {
            document.getElementById('location-modal').style.display = 'block';
            // Load current settings
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.manual_location) {
                        document.querySelector('input[name="location-type"][value="custom"]').checked = true;
                        document.getElementById('custom-location-input').value = data.manual_location;
                        document.getElementById('custom-location-input').disabled = false;
                    } else {
                        document.querySelector('input[name="location-type"][value="auto"]').checked = true;
                        document.getElementById('custom-location-input').disabled = true;
                    }
                });
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        // Handle radio buttons
        document.querySelectorAll('input[name="location-type"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const customInput = document.getElementById('custom-location-input');
                customInput.disabled = radio.value !== 'custom';
                if (radio.value === 'custom') {
                    customInput.focus();
                }
            });
        });

        document.getElementById('location-form').onsubmit = (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="location-type"]:checked').value;
            let newLocation = '';
            if (type === 'custom') {
                newLocation = document.getElementById('custom-location-input').value.trim();
                if (!newLocation) {
                    alert('Please enter a custom location.');
                    return;
                }
            }
            // Update settings
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ manual_location: newLocation })
            }).then(() => {
                closeLocationModal();
                location.reload(); // Reload to update location display
            });
        };

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        document.getElementById('settings-form').onsubmit = (e) => {
            e.preventDefault();
            const newSettings = {
                update_interval: parseInt(document.getElementById('update-interval').value) * 1000,
                power_save: document.getElementById('power-save').checked,
                manual_location: document.getElementById('manual-location').value.trim()
            };
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newSettings)
            }).then(() => {
                closeSettings();
                // Update interval
                clearInterval(intervalId);
                updateInterval = newSettings.update_interval;
                intervalId = setInterval(updateData, updateInterval);
                // Reload page to update location
                location.reload();
            });
        };

        let chart;
        function loadGraph() {
            const btn = document.getElementById('load-graph-btn');
            const loading = document.getElementById('graph-loading');
            btn.disabled = true;
            loading.style.display = 'inline-block';
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            const location = document.getElementById('graph-location').value;
            const url = `/api/graph_data?param=${param}&range=${range}${location ? '&location=' + encodeURIComponent(location) : ''}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(d => d.time);
                    const values = data.map(d => d.value);
                    const ctx = document.getElementById('graph-canvas').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `${param.toUpperCase()} (${location || 'Current Location'})`,
                                data: values,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                })
                .finally(() => {
                    btn.disabled = false;
                    loading.style.display = 'none';
                });
        }

        let compChart;
        function loadComparativeGraph() {
            const btn = document.getElementById('load-comp-btn');
            const loading = document.getElementById('graph-loading');
            btn.disabled = true;
            loading.style.display = 'inline-block';
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            document.getElementById('comp-title').textContent = `Comparative ${param.toUpperCase()} by Location`;
            fetch(`/api/graph_data?param=${param}&range=${range}`)
                .then(response => response.json())
                .then(allData => {
                    // Group by location
                    const locationData = {};
                    allData.forEach(d => {
                        if (!locationData[d.location]) locationData[d.location] = [];
                        locationData[d.location].push(d);
                    });
                    const datasets = Object.keys(locationData).map((loc, i) => ({
                        label: loc,
                        data: locationData[loc].map(d => d.value),
                        borderColor: `hsl(${i * 360 / Object.keys(locationData).length}, 70%, 50%)`,
                        backgroundColor: 'transparent',
                        tension: 0.1
                    }));
                    const labels = allData.slice(0, datasets[0]?.data.length || 0).map(d => d.time);
                    const ctx = document.getElementById('comp-graph-canvas').getContext('2d');
                    if (compChart) compChart.destroy();
                    compChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: true },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                })
                .finally(() => {
                    btn.disabled = false;
                    loading.style.display = 'none';
                });
        }

        function exportData() {
            const param = document.getElementById('graph-param').value;
            const range = document.getElementById('graph-range').value;
            const location = document.getElementById('graph-location').value;
            const url = `/api/export?format=csv${location ? '&location=' + encodeURIComponent(location) : ''}`;
            window.open(url, '_blank');
        }

        function loadReadings() {
            const location = document.getElementById('data-location').value;
            const loading = document.getElementById('data-loading');
            loading.style.display = 'inline-block';
            const url = `/api/readings?limit=100${location ? '&location=' + encodeURIComponent(location) : ''}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('data-tbody');
                    tbody.innerHTML = '';
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="border: 1px solid #ddd; padding: 8px;">${new Date(row.timestamp).toLocaleString()}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${row.location}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${row.pm1 || 'N/A'}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${row.pm25}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${row.pm10 || 'N/A'}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${row.aqi}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
        }

        function cleanupData() {
            if (confirm('Are you sure you want to delete data older than 30 days?')) {
                fetch('/api/cleanup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: 30})
                }).then(() => {
                    alert('Old data cleaned.');
                    loadReadings(); // Refresh the table
                });
            }
        }
    </script>
</body>
</html>